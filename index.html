<!DOCTYPE html>

<!-- npx http-server -p 8000 -->
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://unpkg.com/@googlemaps/markerclusterer@2.5.3/dist/index.min.js"></script>

        <style>
           .loader-container {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
            } 
            .loader {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                position: relative;
                animation: rotate 1s linear infinite
            }
            .loader::before , .loader::after {
                content: "";
                box-sizing: border-box;
                position: absolute;
                inset: 0px;
                border-radius: 50%;
                border: 5px solid #EC6730;
                animation: prixClipFix 2s linear infinite ;
            }
            .loader::after{
                border-color: #ff0000;
                animation: prixClipFix 2s linear infinite, rotate 0.5s linear infinite reverse;
                inset: 6px;
            }
            @keyframes rotate {
                0%   {transform: rotate(0deg)}
                100%   {transform: rotate(360deg)}
            }
            @keyframes prixClipFix {
                0%   {clip-path:polygon(50% 50%,0 0,0 0,0 0,0 0,0 0)}
                25%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 0,100% 0,100% 0)}
                50%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,100% 100%,100% 100%)}
                75%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,0 100%,0 100%)}
                100% {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,0 100%,0 0)}
            }

            body {
                margin: 0;
                padding: 0;
                text-align: center;
            }

            #map {
                height: 700px; 
                margin: auto;
                opacity: 0;
                transition: opacity 2s ease; 
                width: 80%;
                z-index: 100;
            }

            .popupclass {
                font-size: 14px;
                text-align: left;
            }

            .popuptext {
                font-size: 14px;
                text-align: left;
            }

            .leaflet-popup-content-wrapper {
                background-color: #ffffff;
                border: 1px #313030 solid;
                border-bottom: 0;
                box-shadow: 5px -1px 5px 4px rgba(67,67,67,0.72);
                font-family: "Poppins", sans-serif;
            }

            #summary {
                color: #EC6730;
                font-weight: bold;
                font-size: 16px;
                text-transform: uppercase;
                padding-bottom: 5px;
                margin-top: 0;
                max-width: 350px;
                text-align: left;
                border-bottom: #31303030 1px solid;
            }

            #legend {
                background-color: rgba(255, 255, 255, 0.904);
                border-radius: 5px;
                width: fit-content; 
                margin: 15px; 
                border: 3px solid #3C3C3B;
                left: -300px;
                opacity: 0;
                padding: 20px 15px 7px 15px;
                position: absolute;
                text-align: left;
                top: 150px;
                transition: left 1s ease;
                z-index: 500; 
            }
            
            #legendText {
                font-family: "Poppins", sans-serif;
                font-weight: normal; 
                font-size: 14px;
            }

            .marker-cluster-small div {
                background-color: rgba(236, 103, 48, 0.9);
                font-family: "Poppins", sans-serif;
                font-size: 14px;
                font-weight: 600;
            }

            .leaflet-marker-icon.marker-cluster.marker-cluster-small.leaflet-zoom-animated.leaflet-interactive {
                background-color: rgba(236, 103, 48, 0.3) !important;
            }

        </style>
    </head>
    <body>
        <h1>STA Project Map</h1>
        <div class="loader-container" id="loader-container">
            <span class="loader" id="loader"></span>
        </div>
        <div id="map"></div>
        <div id="legend">
        </div>
       
       <script>
            let script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCu1RoRDWwIdCqTNwiwpowwLzQenEZWqWw&callback=initMap`;
            script.async = true;
            document.head.appendChild(script);
            let map;
            let infoWindow;
    
            function initMap(){
                map = new google.maps.Map(document.getElementById("map"), {
                    mapId: 'f21334c79e793a82',
                    center: { lat: 55, lng: -5.5 },
                    zoom: 5.9,
                    minZoom: 4,
                    mapTypeControl: false,
                    streetViewControl: false,
                });

                infoWindow = new google.maps.InfoWindow();  // Create a new InfoWindow

                fetchDataAndProcess();
                let legend = document.getElementById('legend');
                legend.innerHTML = ''; // Clear the legend element
            };

            const newIcons = {
                ARTS: {
                    name: 'Arts & Culture',
                    icon: "https://stamapmarker3.s3.amazonaws.com/MarkerPink.png",
                },
                ENVIRONMENT: {
                    name: 'Environment & Conservation',
                    icon: "https://stamapmarker3.s3.amazonaws.com/MarkerGreen.png",
                },
                HEALTH: {
                    name: 'Health & Social Care',
                    icon: "https://stamapmarker3.s3.amazonaws.com/MarkerBlue.png",
                },
                NONCHARITY: {
                    name: 'Non-charity',
                    icon: "https://stamapmarker3.s3.amazonaws.com/MarkerRed.png",
                },
                EDUCATION: {
                    name: 'Education & Youth',
                    icon: "https://stamapmarker3.s3.amazonaws.com/MarkerPurple.png",
                },
                INTERNAL: {
                    name: 'Internal STA Project',
                    icon: "https://stamapmarker3.s3.amazonaws.com/MarkerOrange.png",
                },
                OTHER: {
                    name: 'Other',
                    icon: "https://stamapmarker3.s3.amazonaws.com/MarkerBlack.png",
                },
            };
        
            let pounds = Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP',
            });

            const projectDataFromJira = [];

            const AWS_API_Gateway = 'https://0wcfxr0v92.execute-api.eu-north-1.amazonaws.com/default/STA_GET_Request';

            async function fetchData() {
                try {
                    const response = await fetch(AWS_API_Gateway, {
                        method: 'GET',
                    });
                    if (!response.ok) {
                        throw new Error('Failed to fetch data');
                    }
                    const data = await response.json();
                    let sector = '';
                    let impactValue = '';
                    for (let i = 0; i < data.issues.length; i++){
                        const postcode = data.issues[i].fields && data.issues[i].fields["customfield_10099"];
                        const summary = data.issues[i].fields && data.issues[i].fields["summary"];
                        
                        if(data.issues[i].fields && data.issues[i].fields["customfield_10148"] != null){
                            sector = data.issues[i].fields && data.issues[i].fields["customfield_10148"].value;
                        }
                        const published = data.issues[i].fields && data.issues[i].fields["customfield_10214"];
                        
                        if(data.issues[i].fields && data.issues[i].fields["customfield_10197"] === null){
                            impactValue = 'TBC';
                        }
                        else {
                            impactValue = `${pounds.format(data.issues[i].fields && data.issues[i].fields["customfield_10197"])}`;
                        };
                        const timespent = data.issues[i].fields && data.issues[i].fields.timespent;
                        const time = ConvertSeconds(timespent);

                        if(postcode !== null && postcode !== undefined && published != null){
                            const projectInformation = {
                                postcode: postcode,
                                summary: summary,
                                sector: sector,
                                impactValue: impactValue,
                                time: time,
                            };
                            projectDataFromJira.push(projectInformation);
                        };
                    };
                } catch (error) {
                    console.error('Error: failed to fetch', error);
                    throw error;
                };
            };

            async function fetchDataAndProcess() {
                try {
                    showSpinner();
                    await fetchData();
           
                    if (Array.isArray(projectDataFromJira)) {
                        const markers = [];
                        for (let location of projectDataFromJira) {
                            try {
                                const coordinates = await Postcode(location.postcode.trim())
                                if (coordinates && coordinates.status === 200) {
                                    let markerIcon;
                                    for (let key in newIcons) {
                                        if (location.sector === newIcons[key].name) {
                                            markerIcon = newIcons[key].icon;
                                            break;
                                        };
                                    };
                
                                    let marker = new google.maps.Marker({
                                        position: {lat: parseFloat(coordinates.result.latitude), lng: parseFloat(coordinates.result.longitude)},
                                        map,
                                        icon: {
                                            url: markerIcon,
                                            scaledSize: new google.maps.Size(30, 30)
                                        },
                                    });
                                    markers.push(marker);
                   
                                    let lastWindow = null;

                                    marker.addListener('click', function() {
                                        // Set content for the InfoWindow
                                        let contentString = `<div class="popupclass">
                                            </div id="summarydiv">
                                                <p id="summary">${location.summary}</p>
                                            </div>
                                            <p class="popuptext"><b>${location.sector}</b></P>
                                            <p class="popuptext"><b>Impact value:</b> ${location.impactValue}</P>
                                            <p class="popuptext"><b>Volunteer hours:</b> ${location.time}</P>
                                            </div>`;
                                                
                                        infoWindow.setContent(contentString);
                                        infoWindow.open(map, marker);

                                        google.maps.event.addListener(map, 'click', function() {
                                            if (infoWindow) {
                                                infoWindow.close();;
                                            };
                                        });
                         
                                        if (lastWindow) lastWindow.close();                 
                                    });
                                };
                            } catch (error) {
                                console.error('Error:', error);
                            };
                        };
                        new markerClusterer.MarkerClusterer({markers, map});
                    };            

                    const imageBounds = {
                        north: 58.98182,
                        south: 57.181400,
                        east:  2.902282,
                        west: -0.502282,
                    };

                    let img = new Image();
                    img.src = 'https://stamapmarker3.s3.amazonaws.com/stapic.png';
                    let staOverlay = new google.maps.GroundOverlay(img.src, imageBounds);
                    staOverlay.setMap(map);

                    for (let key in newIcons) {
                        let type = newIcons[key];
                        let name = type.name;
                        let icon = type.icon;
                        let legendIconRow = document.createElement('div');
                        legendIconRow.style.height = '37px';
                        legendIconRow.innerHTML = `<img style="width: 18px; float:left; margin-top: 4px" src="${icon}" />&nbsp;&nbsp;<span id="legendText">${name.toUpperCase()}</span><br><br>`;
                        legend.appendChild(legendIconRow);
                    };
                } catch (error) {
                    console.error('Error: failed to fetch and process data', error);
                };
                hideSpinner();
            };

            function showSpinner() {
                document.getElementById('loader').style.display = 'block';
                document.getElementById('legend').style.display = 'none';
            };

            function hideSpinner() {
                document.getElementById('loader-container').style.display = 'none';
                showMapAndLegend();
                document.getElementById('legend').style.display = 'block';
            };

            function showMapAndLegend() {
                const mapElement = document.getElementById('map');
                mapElement.style.opacity = '1';
                setTimeout(() => {
                    const legendElement = document.getElementById('legend');
                    legendElement.style.opacity = '0.97';
                    legendElement.style.left = '20px';
                }, 1000);
            };

            async function Postcode(postcode) {
                try {
                    const response = await fetch(`https://api.postcodes.io/postcodes/${postcode}`);
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error getting postcode coordinates:', error);
                    throw error;
                };
            };

            function ConvertSeconds(n) { 
                let day = parseInt( n / (24 * 3600)); 
                n = n % (24 * 3600); 
                let hour = parseInt(n / 3600); 
                n %= 3600; 
                let minutes = n / 60; 
                return `${day}d ${hour}h ${minutes}m`;
            };
        </script>
    </body>
</html>