<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>STA Open Street Map</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.Default.css" />
        <link rel="stylesheet" href="style.css">
        <style>
            html {
                box-sizing: border-box;
                font-size: 100%;
            }

            body {
                margin: 0;
                padding: 0;
                text-align: center;
                font-family:Arial, Helvetica, sans-serif;
            }

            #map {
                margin: auto;
                height: 700px; 
                width: 80%;
            }

            .popupclass {
                font-size: 14px;
            }

            #summary {
                color: #fb0f02;
                font-weight: bold;
            }

            #legend {
                font-size: 12px;
                text-align: left;
            }
        </style>
        
    </head>
    <body>
        <h1>STA Open Street Map</h1>
        <div id="map"></div>

        <div id="legend" style="font-family: Bebas Neue, Arial, sans-serif; font-size: 14px; font-weight: normal; background: #fff; padding: 15px; width: 260px; margin: 15px; border: 3px solid #3C3C3B;">
        </div>

        <script>
            var map = L.map('map').setView([56.7, -3.91], 6.9);
    
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
    
            var markers = L.markerClusterGroup();


            const projectDataFromJira = [];

            const AWS_API_Gateway = 'https://0wcfxr0v92.execute-api.eu-north-1.amazonaws.com/default/STA_GET_Request';

            async function fetchData() {
                try {
                    const response = await fetch(AWS_API_Gateway, {
                        method: 'GET',
                    });
                    if (!response.ok) {
                        throw new Error('Failed to fetch data');
                    }

                    const data = await response.json();
                    console.log('Response data', data)

                    for (let i = 0; i < data.issues.length; i++){
                        const postcode = data.issues[i].fields && data.issues[i].fields["customfield_10099"];
                        const summary = data.issues[i].fields && data.issues[i].fields["summary"];
                        const sector = data.issues[i].fields && data.issues[i].fields["customfield_10148"].value;
                        const published = data.issues[i].fields && data.issues[i].fields["customfield_10214"];
                        const timespent = data.issues[i].fields && data.issues[i].fields.timespent;
                        const time = ConvertSeconds(timespent);

                        if(postcode !== null && postcode !== undefined && published == null){
                            const projectInformation = {
                                postcode: postcode,
                                summary: summary,
                                sector: sector,
                                time: time,
                            };
                            projectDataFromJira.push(projectInformation);
                        };
                    };
                    
                } catch (error) {
                    console.error('Error: failed to fetch', error);
                    throw error;
                };
            };

            async function fetchDataAndProcess() {
                try {
                    await fetchData();
                    if (Array.isArray(projectDataFromJira)) {
                        projectDataFromJira.forEach((location) => {
                            async function getCoordinates() {
                                try {
                                    const coordinates = await Postcode(location.postcode.trim())
    
                                    if (coordinates && coordinates.status === 200) {
                                        lat = parseFloat(coordinates.result.latitude)
                                        lng = parseFloat(coordinates.result.longitude)}
                                        const marker = L.marker([lat, lng])
                                            .bindPopup(`<div class="popupclass"><b id='summary'>${location.summary}</b><br><br>${location.sector}<br><br><b>Volunteer hours:</b> ${location.time}</div>`)
                                            .addTo(markers);
                                    } 
                                catch (error) {
                                    console.error('Error:', error)
                                }
                            }
                            getCoordinates();
                        });
                

                        // var imageBounds = {
                        //     north: 58.98182,
                        //     south: 57.181400,
                        //     east:  2.902282,
                        //     west: -0.502282,
                        // };

                        // var img = new Image();
                        // img.src = './stapic.png';
                        // var staOverlay = new google.maps.GroundOverlay(img.src, imageBounds);
                        // staOverlay.setMap(map);

                        const icons = {
                            HEALTH: {
                                name: 'HEALTH AND SOCIAL CARE',
                                icon: 'MarkerPink.png'
                            },
                            LOCAL: {
                                name: 'LOCAL BUSINESS RECOVERY',
                                icon: 'MarkerGreen.png'
                            },
                            TRAVEL: {
                                name: 'TRAVEL AND TOURISM',
                                icon: 'MarkerBlue.png'
                            },
                            REMOTE: {
                                name: 'REMOTE SUPPORT',
                                icon: 'MarkerRed.png'
                            },
                            EDUCATION: {
                                name: 'EDUCATION AND TRAINING',
                                icon: 'MarkerPurple.png'
                            }
                        };

                        for (let key in icons) {
                            let type = icons[key];
                            let name = type.name;
                            let icon = type.icon;
                            let div = document.createElement('div');
                            div.innerHTML = `<img style="width: 18px; float:left;" src="${icon}">&nbsp;&nbsp; ${name}<br><br>`
                            legend.appendChild(div);
                        }
                    };
                
                    map.addLayer(markers);
            
                    // var popup = L.popup();

                } catch (error) {
                    console.error('Error: failed to fetch and process data', error);
                };
            };

            fetchDataAndProcess();


            async function Postcode(postcode) {
                try {
                    const response = await fetch(`https://api.postcodes.io/postcodes/${postcode}`);
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error getting postcode coordinates:', error);
                    throw error;
                };
            };

            function ConvertSeconds(n) { 
                var day = parseInt( n / (24 * 3600)); 
                n = n % (24 * 3600); 
                var hour = parseInt(n / 3600); 
                n %= 3600; 
                var minutes = n / 60; 
                return `${day}d ${hour}h ${minutes}m`;
            };
        </script>
    </body>
</html>